{
  "persona": "Security Lens",
  "wins": [
    "E-004 architectural test (AuthorizationArchitectureTests.cs) achieved ZERO authorization findings across all 5 Epic 4 stories — first epic with perfect auth coverage. Reflection-based enforcement catches missing ITenantContext at compile time.",
    "Global query filters applied on Recruitment, ImportSession, and Candidate entities (A-003 from Epic 3) provide defense-in-depth. All aggregate roots now have EF Core query filter protection.",
    "SAS token max enforcement (15-minute cap) implemented in BlobStorageService.GenerateSasUri — server-side clamp prevents caller-requested excessive validity periods (Epic 3 deferred item resolved).",
    "Rate limiting applied to file upload endpoints (10 requests/min per user) with user-scoped partitioning via JWT claims — protects against DoS via document upload abuse (Epic 3 deferred item resolved).",
    "FluentValidation coverage expanded to all 4 new handlers (GetCandidatesQuery, GetCandidateByIdQuery, RecordOutcomeCommand, GetCandidateOutcomeHistoryQuery) — input validation enforced at application boundary."
  ],
  "problems": [
    "A-006 (Epic 3 P1) NOT APPLIED in handlers — AssignDocumentCommandValidator blob URL check added in self-healing commit 3e89f85, but AssignDocumentCommandHandler.cs still accepts request.DocumentBlobUrl at line 40 without runtime validation that blob belongs to recruitment's storage container. Validator rule uses string prefix check (`url.StartsWith(recruitmentId)`) which is fragile — attacker can craft URLs like `{legitimateRecruitmentId}/../{targetRecruitmentId}/document.pdf` to traverse paths. No blob existence or ownership verification against Azure storage.",
    "A-009 (Epic 3 P2) PARTIALLY APPLIED — NotFoundException handler redacts Detail field (line 60-71 of CustomExceptionHandler.cs omits `Detail = ex.Message`), BUT NotFoundException constructor at line 20-23 still embeds entity type name and GUID in message: `Entity \"{name}\" ({key}) was not found.` This leaks internal schema (table names) and entity IDs (GUIDs) which aid reconnaissance attacks. Six other exception handlers still expose `Detail = ex.Message` (lines 106, 119, 132, 145, 158, 171).",
    "Missing FluentValidation on 3 of 4 new query/command inputs caught only in review — Story 4.1 C1 (GetCandidatesQuery, GetCandidateByIdQuery) and Story 4.3 I1 (GetCandidateOutcomeHistoryQuery) initially shipped without validators. Pattern: validators are added reactively after code review, not proactively during implementation. Indicates test-first discipline not covering input validation security boundary.",
    "No security tests for SAS token refresh flow — useSasUrl.ts and usePdfPrefetch.ts implement client-side SAS token refresh logic (Story 4.2), but no tests verify token expiry behavior, concurrent refresh handling, or token reuse prevention. Frontend test coverage is 285 passing tests, but no explicit SAS security scenarios.",
    "RecordedByUserId exposed in API responses but not resolved to user names — OutcomeHistoryDto (Story 4.1, 4.3) returns raw user GUIDs in RecordedByUserId field. No PII risk (GUIDs are not PII), but exposes internal user ID structure. Previous retro (Epic 3) noted this as M2/M3 minor findings — still not addressed.",
    "ScreeningEndpoints.cs does NOT inject ITenantContext directly — endpoints at lines 19-40 rely on MediatR handlers to perform authorization. This is architecturally correct per CQRS pattern, but creates risk if handler forgets auth check. E-004 architectural test mitigates this at handler layer, but endpoint layer has no compile-time enforcement.",
    "Code coverage metrics still unavailable (4th consecutive epic) — A-005 (Epic 3 P1) added reportgenerator step to ci.yml, but Epic 4 evidence bundle reports 'Cannot execute Application.UnitTests/FunctionalTests' due to missing runtime. No coverage % reported for 13,046 new lines across Epic 4. Security test adequacy cannot be quantified."
  ],
  "missing_evidence": [
    "SAS token generation audit trail — no evidence of logging when SAS URLs are generated (who requested, for which blob, expiry time). BlobStorageService.GenerateSasUri has no instrumentation.",
    "Cross-recruitment data leakage test scenarios — E-004 architectural test enforces ITenantContext injection, but no integration tests verify users in Recruitment A cannot access Candidate/Document data from Recruitment B via API manipulation.",
    "Rate limiting bypass testing — RateLimitPolicies.FileUpload configured, but no evidence of tests verifying 429 responses after threshold exceeded, or that partition key extraction handles missing JWT claims correctly.",
    "Azure Blob Storage access control verification — no tests confirm frontend cannot directly access blob URLs without server-generated SAS tokens. Current architecture assumes blobs are private, but no automated verification.",
    "Background service authorization testing — ProcessPdfBundleCommandHandler is exempt from ITenantContext requirement (legitimate service context), but no tests verify it correctly scopes operations to target recruitment and doesn't leak across boundaries."
  ],
  "candidate_actions": [
    {
      "id": "SEC-001",
      "title": "Enforce blob ownership verification in AssignDocumentCommand handler",
      "type": "security_hardening",
      "priority": "P0",
      "rationale": "A-006 from Epic 3 marked as applied but implementation incomplete. AssignDocumentCommandValidator string prefix check is bypassable via path traversal. Handler must verify blob exists in Azure Storage AND belongs to recruitment's container before assignment. Current code allows cross-recruitment document exfiltration if attacker knows victim blob URL.",
      "evidence_refs": [
        "api/src/Application/Features/Candidates/Commands/AssignDocument/AssignDocumentCommandHandler.cs:40 (accepts request.DocumentBlobUrl without runtime ownership check)",
        "api/src/Application/Features/Candidates/Commands/AssignDocument/AssignDocumentCommandValidator.cs:10-12 (string prefix check vulnerable to ../.. traversal)",
        "_bmad-output/implementation-artifacts/epic-3-retro-2026-02-14.md:63 (A-006 original action item)",
        "context.md:231 (A-006 status: NOT APPLIED)"
      ],
      "acceptance_criteria": [
        "AssignDocumentCommandHandler calls IBlobStorageService.VerifyBlobOwnership(containerName, blobUrl, recruitmentId) before assigning document",
        "VerifyBlobOwnership returns false if blob path does not start with `{recruitmentId}/` after normalization (remove ../ and ./ segments)",
        "Handler throws ForbiddenAccessException if ownership check fails",
        "Unit test AssignDocumentCommandHandlerTests verifies cross-recruitment blob assignment is rejected",
        "Functional test verifies 403 response when attempting to assign another recruitment's document"
      ],
      "automation_hints": [
        "Add IBlobStorageService.VerifyBlobOwnership(string container, string blobUrl, Guid recruitmentId) method",
        "Implementation: parse blob path, normalize (Path.GetFullPath or Uri normalization), verify starts with recruitmentId",
        "Call before line 40 in AssignDocumentCommandHandler: if (!await blobStorage.VerifyBlobOwnership(...)) throw new ForbiddenAccessException();",
        "Remove fragile string prefix check from validator (move to handler where Azure SDK can be used)"
      ],
      "files_to_touch": [
        "/home/thomasg/Projects/Web/recruitment-tracker-epic4/api/src/Application/Common/Interfaces/IBlobStorageService.cs",
        "/home/thomasg/Projects/Web/recruitment-tracker-epic4/api/src/Infrastructure/Services/BlobStorageService.cs",
        "/home/thomasg/Projects/Web/recruitment-tracker-epic4/api/src/Application/Features/Candidates/Commands/AssignDocument/AssignDocumentCommandHandler.cs",
        "/home/thomasg/Projects/Web/recruitment-tracker-epic4/api/tests/Application.UnitTests/Features/Candidates/Commands/AssignDocumentCommandHandlerTests.cs"
      ],
      "risk_if_ignored": "Attacker with valid recruitment access can assign documents from other recruitments to their candidates, exfiltrating sensitive CV data across tenant boundaries. Violates core security boundary (recruitment-scoped data isolation)."
    },
    {
      "id": "SEC-002",
      "title": "Complete entity key redaction in NotFoundException and all exception handlers",
      "type": "security_hardening",
      "priority": "P1",
      "rationale": "A-009 from Epic 3 marked as applied but only 1 of 8 exception handlers redacts detail. NotFoundException constructor still embeds entity type + GUID in message (line 20-23 of NotFoundException.cs). Six other handlers expose `Detail = ex.Message` leaking domain exception messages. Information disclosure aids attacker reconnaissance (schema inference, valid ID enumeration).",
      "evidence_refs": [
        "api/src/Application/Common/Exceptions/NotFoundException.cs:20-23 (constructor embeds entity name and key in message)",
        "api/src/Web/Infrastructure/CustomExceptionHandler.cs:60-71 (NotFoundException handler redacts Detail — GOOD)",
        "api/src/Web/Infrastructure/CustomExceptionHandler.cs:106,119,132,145,158,171 (6 handlers still expose Detail = ex.Message)",
        "_bmad-output/implementation-artifacts/epic-3-retro-2026-02-14.md:71 (A-009 original action)",
        "context.md:234 (A-009 status: NOT APPLIED)"
      ],
      "acceptance_criteria": [
        "NotFoundException constructor message does not include entity name or key — use generic message: 'The requested resource was not found.'",
        "NotFoundException logs entity name + key at Warning level (internal observability) but does not expose in exception message",
        "All 7 exception handlers in CustomExceptionHandler (RecruitmentClosed, StepHasOutcomes, DuplicateStepName, DomainRuleViolation, DuplicateCandidate, InvalidWorkflowTransition, NotFoundException) omit Detail field or use sanitized generic message",
        "Functional test verifies 404 response body does not contain GUIDs or entity type names when resource not found",
        "Security test verifies 400/409 responses do not leak internal entity structure"
      ],
      "automation_hints": [
        "Change NotFoundException constructor to: base(\"The requested resource was not found.\")",
        "In constructor, add _logger call (inject ILogger) before throwing: _logger.LogWarning(\"Entity {EntityName} ({Key}) not found\", name, key)",
        "Remove Detail = ex.Message from lines 106, 119, 132, 145, 158, 171 in CustomExceptionHandler.cs",
        "Add unit tests in CustomExceptionHandlerTests verifying ProblemDetails.Detail is null or generic for all exception types"
      ],
      "files_to_touch": [
        "/home/thomasg/Projects/Web/recruitment-tracker-epic4/api/src/Application/Common/Exceptions/NotFoundException.cs",
        "/home/thomasg/Projects/Web/recruitment-tracker-epic4/api/src/Web/Infrastructure/CustomExceptionHandler.cs",
        "/home/thomasg/Projects/Web/recruitment-tracker-epic4/api/tests/Web.UnitTests/Infrastructure/CustomExceptionHandlerTests.cs (if exists, else create)"
      ],
      "risk_if_ignored": "Attackers gain free reconnaissance: valid entity type names (table schema), GUID format validation (can enumerate valid IDs), domain rule structure. Low-severity information disclosure, but violates defense-in-depth principle."
    },
    {
      "id": "SEC-003",
      "title": "Add 8 mandatory security test scenarios covering cross-recruitment isolation",
      "type": "test_gap",
      "priority": "P0",
      "rationale": "E-004 architectural test enforces ITenantContext at compile time (GOOD), but no runtime integration tests verify users cannot access other recruitments' data via API. Global query filters (A-003) applied but untested. Missing evidence: 'Can a user in Recruitment A ever see data from Recruitment B?' Zero cross-tenant isolation tests across 4 epics.",
      "evidence_refs": [
        "api/tests/Application.UnitTests/Architecture/AuthorizationArchitectureTests.cs (compile-time enforcement only)",
        "api/src/Infrastructure/Data/ApplicationDbContext.cs:29-56 (global query filters — untested)",
        "context.md:199-207 (E-004 PASS based on no findings — no positive security tests)",
        "missing_evidence: 'Cross-recruitment data leakage test scenarios'"
      ],
      "acceptance_criteria": [
        "8 functional tests in Application.FunctionalTests/Security/TenantIsolationTests.cs covering: (1) GetCandidates for other recruitment returns 403, (2) GetCandidateById for other recruitment returns 404, (3) RecordOutcome for other recruitment's candidate returns 403/404, (4) AssignDocument to other recruitment's candidate returns 403, (5) GetOutcomeHistory for other recruitment returns 403/404, (6) GetImportSession for other recruitment returns 403/404, (7) UploadDocument to other recruitment returns 403, (8) Global query filter on Candidate prevents cross-recruitment DbSet access",
        "Test setup: Create 2 recruitments with different users (Alice in Recruitment A, Bob in Recruitment B), attempt cross-access with Alice's JWT trying to access Bob's data",
        "All 8 tests PASS — verify 403 Forbidden or 404 Not Found responses (404 acceptable if global query filter prevents entity from being found)",
        "Tests run in CI pipeline (Application.FunctionalTests suite)"
      ],
      "automation_hints": [
        "Create TenantIsolationTests.cs fixture with 2 recruitments + 1 user each + candidates in each",
        "Use WebApplicationFactory<Program> for integration testing with real DbContext",
        "Generate JWT for Alice, attempt GET /recruitments/{BobRecruitmentId}/candidates — expect 403 or 404",
        "Use Theory with InlineData for all 8 endpoint scenarios",
        "Test global query filter directly: inject DbContext in service scope, set TenantContext to Alice, query Candidates where RecruitmentId == BobRecruitmentId — should return empty"
      ],
      "files_to_touch": [
        "/home/thomasg/Projects/Web/recruitment-tracker-epic4/api/tests/Application.FunctionalTests/Security/TenantIsolationTests.cs (create)",
        "/home/thomasg/Projects/Web/recruitment-tracker-epic4/api/tests/Application.FunctionalTests/Testing.cs (add fixture setup helpers)"
      ],
      "risk_if_ignored": "No automated verification that core security boundary (recruitment-scoped isolation) works. Global query filters and ITenantContext enforcement exist but are untested — regressions will not be caught. High-severity data leakage risk if auth checks are accidentally removed or bypassed."
    },
    {
      "id": "SEC-004",
      "title": "Add input validation test-first discipline to story workflow",
      "type": "guideline_gap",
      "priority": "P1",
      "rationale": "3 of 4 new handlers initially missing FluentValidation (caught in review as Critical/Important findings in Stories 4.1 and 4.3). Pattern: validators are added reactively, not as part of TDD red-green-refactor cycle. Input validation is a security boundary — missing validators allow malformed/malicious input to reach handlers.",
      "evidence_refs": [
        "context.md:119-124 (Story 4.1: C1 missing validators on GetCandidatesQuery and GetCandidateByIdQuery)",
        "context.md:140-145 (Story 4.3: I1 missing validator on GetCandidateOutcomeHistoryQuery)",
        "context.md:163 (Critical: 3, all in Story 4.1 — 2 of 3 were missing validators)",
        "Grep output: 17 validators across Application layer — retroactive pattern"
      ],
      "acceptance_criteria": [
        "Update docs/testing-pragmatic-tdd.md and .claude/process/team-workflow.md: add 'Input Validation' as mandatory red-green-refactor step for test-first mode",
        "Story workflow checklist: 'For each command/query, write failing validator test BEFORE handler implementation'",
        "Validator test template: verify (1) NotEmpty on required fields, (2) Must() rules on business constraints, (3) error messages are specific",
        "Pre-review checklist updated: 'All IRequest<T> types have corresponding AbstractValidator<T> registered in DI'",
        "Architectural test (optional): scan all IRequest implementations, verify matching validator exists in Application assembly"
      ],
      "automation_hints": [
        "Add to team-workflow.md under 'Story Implementation' section: '3. Write validator tests first (Red): For each command/query input, write ValidatorTests.cs with NotEmpty and business rule assertions'",
        "Create validator test template in .claude/templates/ValidatorTests.cs.template",
        "Optional: create ArchitectureTests/ValidatorCoverageTests.cs — scan all IRequest<T> types, verify AbstractValidator<T> exists",
        "Update pre-review checklist in team-workflow.md: add 'Input validation' as item #2 (after 'Authorization checks')"
      ],
      "files_to_touch": [
        "/home/thomasg/Projects/Web/recruitment-tracker-epic4/docs/testing-pragmatic-tdd.md",
        "/home/thomasg/Projects/Web/recruitment-tracker-epic4/.claude/process/team-workflow.md",
        "/home/thomasg/Projects/Web/recruitment-tracker-epic4/.claude/templates/ValidatorTests.cs.template (create)",
        "/home/thomasg/Projects/Web/recruitment-tracker-epic4/api/tests/Application.UnitTests/Architecture/ValidatorCoverageTests.cs (optional)"
      ],
      "risk_if_ignored": "Continued pattern of missing validators caught only in review — increases fix cycle rate and risk of malformed input reaching handlers. Security boundary (input validation) is treated as optional polish, not core requirement."
    },
    {
      "id": "SEC-005",
      "title": "Instrument SAS token generation with audit logging",
      "type": "security_hardening",
      "priority": "P2",
      "rationale": "BlobStorageService.GenerateSasUri generates 15-minute read tokens for candidate documents, but no audit trail exists. Cannot answer: who accessed which document, when, or detect anomalous SAS generation patterns (e.g., bulk download attempts). Compliance risk for recruitment data access auditing.",
      "evidence_refs": [
        "api/src/Infrastructure/Services/BlobStorageService.cs:49-64 (GenerateSasUri — no logging)",
        "missing_evidence: 'SAS token generation audit trail'",
        "context.md:23 (Story 4.1 AC includes batch SAS URL generation — no logging for bulk access)"
      ],
      "acceptance_criteria": [
        "BlobStorageService.GenerateSasUri logs at Information level: UserId (from ITenantContext), RecruitmentId, blobName, expiryTime, timestamp",
        "Log structured format: 'SAS token generated for blob {BlobName} in recruitment {RecruitmentId} by user {UserId}, expires {ExpiryTime}'",
        "AuditEntry entity (already exists per context.md:22) optionally records SAS generation events with EntityType='Document', Action='SAS_GENERATED', UserId, timestamp",
        "Audit log queryable via future admin/compliance endpoint (not implemented in this action — just instrument)",
        "No PII in logs (candidate name/email) — use document ID only"
      ],
      "automation_hints": [
        "Inject ITenantContext into BlobStorageService constructor",
        "In GenerateSasUri, add: _logger.LogInformation(\"SAS token generated for blob {BlobName} in recruitment {RecruitmentId} by user {UserId}, expires {ExpiryTime}\", blobName, _tenantContext.RecruitmentId, _tenantContext.UserGuid, DateTimeOffset.UtcNow.Add(validity))",
        "Optional: insert AuditEntry via IApplicationDbContext if compliance requirement confirmed (consult Product Owner first — may be overkill)"
      ],
      "files_to_touch": [
        "/home/thomasg/Projects/Web/recruitment-tracker-epic4/api/src/Infrastructure/Services/BlobStorageService.cs"
      ],
      "risk_if_ignored": "No audit trail for document access. Cannot investigate compliance questions ('who downloaded this candidate's CV?') or detect bulk exfiltration attempts. Low immediate risk, but blocking for future compliance certifications (SOC 2, ISO 27001)."
    },
    {
      "id": "SEC-006",
      "title": "Restore code coverage metrics and enforce security test thresholds",
      "type": "test_gap",
      "priority": "P1",
      "rationale": "A-005 from Epic 3 added reportgenerator to ci.yml but Epic 4 reports 'Cannot execute Application.UnitTests' — 4th consecutive epic without coverage. 13,046 new lines in Epic 4 with zero quantitative test adequacy. Cannot measure security test coverage (validators, auth checks, input sanitization).",
      "evidence_refs": [
        "context.md:112-113 (Code Coverage: Not measured. 4th consecutive epic without coverage metrics)",
        "context.md:106-109 (Application.UnitTests/FunctionalTests cannot execute — requires runtime)",
        "context.md:225-226 (A-005 status: NOT APPLIED — 4th epic without coverage)",
        "_bmad-output/implementation-artifacts/epic-3-retro-2026-02-14.md:62 (A-005: Enable code coverage with CI thresholds 70% domain, 60% application)"
      ],
      "acceptance_criteria": [
        "Install Microsoft.AspNetCore.App 10.0.0 runtime on CI agent (Linux) or run tests in Docker container with runtime",
        "Application.UnitTests and Application.FunctionalTests execute successfully in CI pipeline",
        "Coverage report generated and published to CI artifacts (HTML + Cobertura XML)",
        "Coverage thresholds enforced: 70% line coverage for Domain, 60% for Application (warning only, not blocking — monitor for 1 epic before enforcing)",
        "Coverage report includes security-critical paths: all AbstractValidator classes, all ITenantContext usage sites, all ForbiddenAccessException throw paths"
      ],
      "automation_hints": [
        "Add to .github/workflows/ci.yml: install .NET 10 runtime (not just SDK) before test step",
        "Alternatively: run dotnet test in Docker container (mcr.microsoft.com/dotnet/aspnet:10.0)",
        "Use coverlet.collector (already installed): dotnet test --collect:\"XPlat Code Coverage\"",
        "Add ReportGenerator step: reportgenerator -reports:**/coverage.cobertura.xml -targetdir:coveragereport -reporttypes:Html;Cobertura",
        "Add coverage threshold check: dotnet test --collect:\"XPlat Code Coverage\" -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Threshold=70",
        "Publish coverage HTML as CI artifact (GitHub Actions: actions/upload-artifact@v4)"
      ],
      "files_to_touch": [
        "/home/thomasg/Projects/Web/recruitment-tracker-epic4/.github/workflows/ci.yml"
      ],
      "risk_if_ignored": "No quantitative signal on test adequacy. Security-critical code (validators, auth checks) may be untested. Cannot track coverage trends or enforce minimum thresholds. 4 epics (50+ stories) shipped without coverage metrics — technical debt compounds."
    }
  ]
}
